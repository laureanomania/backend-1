<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lista de Productos</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #1e1e1e; /* Fondo negro */
        color: #f0f0f0; /* Texto claro */
      }
      h1,
      h2 {
        color: #ffdd00; /* Amarillo */
        text-align: center; /* Centrar */
      }
      .cart-container {
        text-align: center; /* Centrar */
        margin-bottom: 20px;
      }
      .product,
      .cart-product {
        border: 1px solid #333;
        border-radius: 5px;
        background-color: #2a2a2a; /* Fondo oscuro */
        padding: 20px;
        margin: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        transition: transform 0.2s;
        width: calc(33% - 20px);
        box-sizing: border-box;
        float: left;
      }
      .product:hover,
      .cart-product:hover {
        transform: scale(1.02);
      }
      .product img,
      .cart-product img {
        max-width: 100%;
        height: auto;
        display: block;
        margin-bottom: 10px;
      }
      .product img.placeholder,
      .cart-product img.placeholder {
        width: 100%;
        height: 200px;
        background-color: white; /* Cuadrado blanco */
      }
      .product h2,
      .cart-product h2 {
        margin-top: 0;
        color: #ffdd00; /* Amarillo */
      }
      .product p,
      .cart-product p {
        margin: 5px 0;
        color: #bbb;
      }
      .product .price,
      .cart-product .price {
        font-size: 1.2em;
        color: #ffdd00; /* Amarillo */
        margin-top: 10px;
      }
      .add-to-cart,
      .remove-from-cart {
        background-color: #ffdd00; /* Amarillo */
        color: #1e1e1e; /* Negro */
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .add-to-cart:hover,
      .remove-from-cart:hover {
        background-color: #ffc107; /* Amarillo claro */
      }
      .clearfix::after {
        content: "";
        clear: both;
        display: table;
      }
      #view-cart,
      #clear-cart {
        background-color: #ffdd00; /* Amarillo */
        color: #1e1e1e; /* Negro */
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 10px 5px;
        transition: background-color 0.3s;
      }
      #view-cart:hover,
      #clear-cart:hover {
        background-color: #ffc107; /* Amarillo claro */
      }
    </style>
  </head>
  <body>
    <h1>Productos</h1>
    <div class="cart-container">
      <button id="view-cart">Ver Carrito</button>
      <button id="clear-cart">Vaciar Carrito</button>
    </div>
    <h2>Carrito de Compras</h2>
    <div id="cart-list" class="clearfix"></div>
    <div id="product-list" class="clearfix"></div>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const response = await fetch("/api/products");
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);

          const products = await response.json();
          const productList = document.getElementById("product-list");
          const cartList = document.getElementById("cart-list");
          let cart = JSON.parse(localStorage.getItem("cart")) || [];

          const renderCart = () => {
            cartList.innerHTML = "";
            cart.forEach((item) => {
              const cartItem = document.createElement("div");
              cartItem.classList.add("cart-product");
              cartItem.innerHTML = `
              <h2>${item.title}</h2>
              <p>${item.description}</p>
              <p><strong>Precio:</strong> $${item.price}</p>
              <p><strong>Cantidad:</strong> ${item.quantity}</p>
              <button class="remove-from-cart" data-id="${item.id}">Eliminar uno</button>
            `;
              cartList.appendChild(cartItem);
            });
          };

          products.forEach((product) => {
            const productDiv = document.createElement("div");
            productDiv.classList.add("product");

            productDiv.innerHTML = `
            <img src="${product.thumbnails[0]}" alt="${product.title}" onerror="this.onerror=null;this.src='';this.classList.add('placeholder');">
            <h2>${product.title}</h2>
            <p>${product.description}</p>
            <p><strong>Código:</strong> ${product.code}</p>
            <p><strong>Categoría:</strong> ${product.category}</p>
            <p><strong>Stock:</strong> <span id="stock-${product.id}">${product.stock}</span></p>
            <p class="price"><strong>Precio:</strong> $${product.price}</p>
            <button class="add-to-cart" data-id="${product.id}">Añadir al Carrito</button>
          `;

            productList.appendChild(productDiv);
          });

          document
            .getElementById("view-cart")
            .addEventListener("click", renderCart);

          document
            .getElementById("clear-cart")
            .addEventListener("click", () => {
              cart = [];
              localStorage.setItem("cart", JSON.stringify(cart));
              renderCart();
            });

          document.addEventListener("click", (e) => {
            if (e.target.classList.contains("add-to-cart")) {
              const productId = e.target.dataset.id;
              const product = products.find((p) => p.id === productId);
              const stockElement = document.getElementById(
                `stock-${product.id}`
              );
              let stock = parseInt(stockElement.textContent);

              if (stock > 0) {
                let cartItem = cart.find((item) => item.id === productId);
                if (cartItem) {
                  cartItem.quantity += 1;
                } else {
                  cartItem = { ...product, quantity: 1 };
                  cart.push(cartItem);
                }
                stock -= 1;
                stockElement.textContent = stock;

                localStorage.setItem("cart", JSON.stringify(cart));
                product.stock = stock;
              } else {
                alert("No hay suficiente stock para este producto.");
              }
            }

            if (e.target.classList.contains("remove-from-cart")) {
              const productId = e.target.dataset.id;
              let cartItem = cart.find((item) => item.id === productId);
              if (cartItem) {
                const stockElement = document.getElementById(
                  `stock-${productId}`
                );
                let stock = parseInt(stockElement.textContent);

                if (cartItem.quantity > 1) {
                  cartItem.quantity -= 1;
                  stock += 1;
                } else {
                  stock += 1;
                  cart = cart.filter((item) => item.id !== productId);
                }

                stockElement.textContent = stock;
                localStorage.setItem("cart", JSON.stringify(cart));
                renderCart();
              }
            }
          });
        } catch (error) {
          console.error("Error fetching products:", error);
          document.getElementById("product-list").innerHTML =
            "<p>Hubo un error al recuperar los productos. Por favor, inténtalo de nuevo más tarde.</p>";
        }
      });
    </script>
  </body>
</html>
